<div id="file-row-{{ doc.id }}" 
     data-filename="{{ doc.filename }}" 
     class="bg-dark-card border border-dark-light rounded mb-2 overflow-hidden" 
     {% if oob %}hx-swap-oob="{{ oob }}"{% endif %}>
    <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-dark-lighter transition-colors" onclick="toggleDetails('{{ doc.id }}')">
        <div class="flex items-center gap-3">
            {% if doc.category == 'invoice' %}
                <i class="fa-solid fa-file-invoice-dollar text-green-400"></i>
            {% elif doc.category == 'contract' %}
                <i class="fa-solid fa-file-contract text-blue-400"></i>
            {% else %}
                <i class="fa-solid fa-file text-gray-400"></i>
            {% endif %}
            <span class="text-sm font-medium text-gray-200 break-all">{{ doc.filename }}</span>
        </div>
        <div class="flex items-center gap-4">
            {% if doc.discrepancies and doc.discrepancies|length > 0 %}
                <span id="status-{{ doc.id }}" class="px-2 py-1 text-xs rounded bg-red-900 text-red-200 border border-red-700">
                    {{ doc.discrepancies|length }} Discrepancies
                </span>
            {% elif doc.category == 'invoice' and (not doc.extracted_data or not doc.extracted_data.get('matched_contract_id')) %}
                <span id="status-{{ doc.id }}" class="px-2 py-1 text-xs rounded bg-yellow-900 text-yellow-200 border border-yellow-700">
                    No Contract Match
                </span>
                <span class="ml-2 px-2 py-1 text-xs rounded bg-dark-lighter border border-dark-light hover:bg-dark-light hover:text-white cursor-pointer transition-colors z-10" 
                      onclick="event.stopPropagation(); retryMatch('{{ doc.id }}')">
                    <i class="fa-solid fa-rotate-right mr-1"></i> Retry
                </span>
            {% elif doc.category == 'invoice' and doc.extracted_data.get('matched_contract_id') %}
                <span id="status-{{ doc.id }}" class="px-2 py-1 text-xs rounded bg-green-900 text-green-200 border border-green-700">
                    Matched
                </span>
            {% elif doc.category == 'contract' %}
                <span id="status-{{ doc.id }}" class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 border border-gray-600">
                    Indexed {% if children is not none %}<span class="ml-1 text-gray-400">({{ children|length }})</span>{% endif %}
                </span>
            {% elif doc.category == 'processing' %}
                <span id="status-{{ doc.id }}" class="px-2 py-1 text-xs rounded bg-blue-900/30 text-blue-200 border border-blue-700/50 animate-pulse">
                    Processing
                </span>
                <span class="ml-2 px-2 py-1 text-xs rounded bg-dark-lighter border border-dark-light hover:bg-dark-light hover:text-white cursor-pointer transition-colors z-10" 
                      onclick="event.stopPropagation(); retryMatch('{{ doc.id }}')">
                    <i class="fa-solid fa-rotate-right mr-1"></i> Retry
                </span>
            {% else %}
                <span id="status-{{ doc.id }}" class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-300 border border-gray-600">
                    {{ doc.category }}
                </span>
            {% endif %}
            <i id="icon-{{ doc.id }}" class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-200"></i>
        </div>
    </div>

    <div id="details-{{ doc.id }}" class="hidden border-t border-dark-light bg-dark-darker p-4 text-sm break-words">
        {% if doc.discrepancies %}
            <h4 class="text-red-300 font-semibold mb-2">Discrepancies Found:</h4>
            <ul class="space-y-2 mb-4">
                {% for disc in doc.discrepancies %}
                <li class="bg-red-950/30 p-2 rounded border border-red-900/50">
                    <div class="flex justify-between mb-1">
                        <span class="font-mono text-xs text-red-400 uppercase">{{ disc.field }}</span>
                        <span class="text-xs text-gray-500">{{ disc.issue }}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-xs">
                        <div>
                            <span class="text-gray-500 block">Invoice:</span>
                            <span class="text-gray-200">{{ disc.invoice_value }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 block">Contract:</span>
                            <span class="text-gray-200">{{ disc.contract_value }}</span>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% endif %}
        
        {% if doc.reconciliation_notes %}
            <h4 class="text-gray-300 font-semibold mb-2">Analysis Notes:</h4>
            <p class="text-gray-400 mb-4">{{ doc.reconciliation_notes }}</p>
        {% endif %}
        
        {% if doc.extracted_data %}
        <div class="pt-4 border-t border-dark-light">
            <h4 class="text-gray-300 font-semibold mb-2">Extracted Data:</h4>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs">
                {% for key, value in doc.extracted_data.items() %}
                    {% if key != 'line_items' and value is not none %}
                    <div class="flex flex-col">
                        <span class="text-gray-500 capitalize">{{ key|replace('_', ' ') }}</span>
                        <span class="text-gray-200 break-words">{{ value }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if doc.text_content %}
        <div class="pt-4 border-t border-dark-light">
            <details class="group">
                <summary class="text-gray-300 font-semibold mb-2 cursor-pointer list-none flex items-center gap-2 select-none outline-none">
                    <i class="fa-solid fa-chevron-right text-xs text-gray-500 group-open:rotate-90 transition-transform duration-200"></i>
                    <span>Contract Content (Raw)</span>
                </summary>
                <div class="text-xs text-gray-400 font-mono whitespace-pre-wrap max-h-60 overflow-y-auto bg-dark-light p-2 rounded mt-2">{{ doc.text_content }}</div>
            </details>
        </div>
        {% endif %}
        
        {% if doc.category == 'contract' %}
        <div id="contract-children-{{ doc.id }}" class="mt-4 space-y-2 pl-4 border-l-2 border-dark-light">
            {% if children %}
                {% for child in children %}
                    {% with doc=child, children=None %}
                        {% include "extraction/partials/row.html" %}
                    {% endwith %}
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>