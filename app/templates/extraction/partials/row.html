{% import "extraction/macros.html" as macros %}
<div id="file-row-{{ doc.id }}" 
     data-filename="{{ doc.filename }}" 
     class="bg-dark-card border border-dark-light rounded mb-2 overflow-hidden" 
     {% if oob %}hx-swap-oob="{{ oob }}"{% endif %}>
    <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-dark-lighter transition-colors" onclick="toggleDetails('{{ doc.id }}')">
        <div class="flex items-center gap-3">
            {{ macros.type_icon(doc) }}
            <span class="text-sm font-medium text-gray-200 break-all">{{ doc.filename }}</span>
        </div>
        <div class="flex items-center gap-4">
            {{ macros.status_badge(doc) }}
            <i id="icon-{{ doc.id }}" class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-200"></i>
        </div>
    </div>

    <div id="details-{{ doc.id }}" class="hidden border-t border-dark-light bg-dark-darker p-4 text-sm break-words">
        {% if doc.discrepancies %}
            <h4 class="text-red-300 font-semibold mb-2">Discrepancies Found:</h4>
            <ul class="space-y-2 mb-4">
                {% for disc in doc.discrepancies %}
                <li class="bg-red-950/30 p-2 rounded border border-red-900/50">
                    <div class="flex justify-between mb-1">
                        <span class="font-mono text-xs text-red-400 uppercase">{{ disc.field }}</span>
                        <span class="text-xs text-gray-500">{{ disc.issue }}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-xs">
                        <div>
                            <span class="text-gray-500 block">Invoice:</span>
                            <span class="text-gray-200">{{ disc.invoice_value }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 block">Contract:</span>
                            <span class="text-gray-200">{{ disc.contract_value }}</span>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% endif %}
        
        {% if doc.reconciliation_notes %}
            <h4 class="text-gray-300 font-semibold mb-2">Analysis Notes:</h4>
            <p class="text-gray-400 mb-4">{{ doc.reconciliation_notes }}</p>
        {% endif %}
        
        {% if doc.extracted_data %}
        <div class="pt-4 border-t border-dark-light">
            <h4 class="text-gray-300 font-semibold mb-2">Extracted Data:</h4>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs">
                {% for key, value in doc.extracted_data.items() %}
                    {% if key != 'line_items' and value is not none %}
                    <div class="flex flex-col">
                        <span class="text-gray-500 capitalize">{{ key|replace('_', ' ') }}</span>
                        <span class="text-gray-200 break-words">{{ value }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if doc.text_content %}
        <div class="pt-4 border-t border-dark-light">
            <details class="group">
                <summary class="text-gray-300 font-semibold mb-2 cursor-pointer list-none flex items-center gap-2 select-none outline-none">
                    <i class="fa-solid fa-chevron-right text-xs text-gray-500 group-open:rotate-90 transition-transform duration-200"></i>
                    <span>Contract Content (Raw)</span>
                </summary>
                <div class="text-xs text-gray-400 font-mono whitespace-pre-wrap max-h-60 overflow-y-auto bg-dark-light p-2 rounded mt-2">{{ doc.text_content }}</div>
            </details>
        </div>
        {% endif %}
        
        {% if doc.is_contract %}
        <div id="contract-invoices-{{ doc.id }}" class="mt-4 space-y-2 pl-4 border-l-2 border-dark-light">
            {% if doc.linked_invoices %}
                {% for inv in doc.linked_invoices %}
                    {% with doc=inv %}{% include "extraction/partials/row.html" %}{% endwith %}
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>